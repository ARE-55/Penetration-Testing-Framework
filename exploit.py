import subprocess
from urllib.parse import urlparse

def run_metasploit_exploit(target_url, lhost="192.168.1.100", lport="4444"):
    """Run Metasploit hidden directory scan."""
    print(f"\n[+] Running Metasploit exploit on {target_url}...\n")

    # Parse the domain from the URL
    parsed_url = urlparse(target_url)
    target_domain = parsed_url.hostname  # Extract only the domain name

    if not target_domain:
        print("[!] Invalid URL format. Please enter a valid URL.")
        return

    print(f"[+] Target Domain: {target_domain}")

    # ✅ Use Metasploit directory scanner
    command = (
        f"msfconsole -q -x 'use auxiliary/scanner/http/dir_scanner; "
        f"set RHOSTS {target_domain}; "
        f"set RPORT 80; "
        f"set THREADS 10; "
        f"run; exit'"
    )

    result = subprocess.run(command, shell=True, capture_output=True, text=True)

    # ✅ Save the Metasploit results to a report file
    report_filename = "metasploit_dir_scan_report.txt"
    with open(report_filename, "w") as report_file:
        report_file.write(result.stdout)

    print(f"\n[+] Exploitation Results saved in: {report_filename}")
    return result.stdout

if __name__ == "__main__":
    target = input("Enter the target website URL (e.g., http://example.com): ").strip()

    if not target.startswith("http"):
        print("[!] Please include http:// or https:// in the URL.")
        exit()

    # Set your Kali machine IP and listener port
    lhost = input("Enter your Kali IP (e.g., 192.168.1.100): ").strip()
    lport = input("Enter the listener port (e.g., 4444): ").strip()

    exploit_results = run_metasploit_exploit(target, lhost, lport)
    print("\n[+] Exploitation Completed!\n")
